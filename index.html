<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sorteo 200 - JSONP (sin CORS)</title>
<style>
    body { 
        background: linear-gradient(135deg, #ffecd2, #fcb69f);
        font-family: Arial, sans-serif;
        padding: 20px; 
    }

    #numeros { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 14px; 
        justify-content: center; 
    }

    .numero {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: #ffffffcc;
        border: 3px solid #e3c4a8;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        font-weight: bold;
        color: #5a4637;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        transition: transform .15s ease;
    }

    .numero:hover {
        transform: scale(1.08);
    }

    .completo {
        background: #ff5f6d;
        background: linear-gradient(135deg, #ff5f6d, #ffc371);
        border-color: #c54d49;
        color: white;
    }
</style>

</head>
<body>
  <h1>Sorteo — 1 a 200</h1>
  <div id="loader" aria-hidden="true"></div>
  <div id="err"></div>
  <div id="grid" aria-live="polite"></div>
  <div id="status"></div>

<script>
(function(){
  const SHEET_ID = "1tIPI57LEoj73SmYj31A_vrXQNUTO-PUzgZQpEg2CQ-o"; // tu sheet id
  const GID = 0; // si usás otra hoja, cambiá
  // URL JSONP (google devuelve google.visualization.Query.setResponse(...))
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json&tq=&_=${Date.now()}`;

  const loader = document.getElementById('loader');
  const grid = document.getElementById('grid');
  const errBox = document.getElementById('err');
  const status = document.getElementById('status');

  // Preparamos el namespace que la respuesta JSONP invocará:
  window.google = window.google || {};
  window.google.visualization = window.google.visualization || {};
  // Aquí Google llamará a setResponse(obj)
  window.google.visualization.Query = window.google.visualization.Query || {};
  window.google.visualization.Query.setResponse = function(response) {
    try {
      // la estructura viene en response.table.rows
      const rows = (response && response.table && response.table.rows) || [];
      const vendidos = new Set();

      rows.forEach(r => {
        const cells = (r.c || []).map(c => c ? (c.v ?? '') : '');
        // si las 4 primeras columnas existen y no están vacías => marcado
        if (cells.length >= 4 && cells.slice(0,4).every(v => String(v).trim() !== '')) {
          const n = Number(cells[3]); // columna D -> índice 3
          if (!Number.isNaN(n) && n >= 1 && n <= 200) vendidos.add(n);
        }
      });

      renderGrid(vendidos);
      loader.style.display = 'none';
      status.textContent = `Cargados: ${rows.length} filas. Marcados: ${vendidos.size} números.`;
    } catch(e) {
      showError('Error procesando la respuesta: ' + e.message);
    }
  };

  // fallback si el script no carga
  const failTimeout = setTimeout(()=> {
    showError('No se pudo cargar la respuesta de Google (timeout). Reintentá refrescando la página.');
    loader.style.display = 'none';
  }, 15000); // 15s

  // inserto el script JSONP
  const s = document.createElement('script');
  s.src = url;
  s.async = true;
  s.onload = () => { clearTimeout(failTimeout); /* la respuesta llamará setResponse */ };
  s.onerror = () => {
    clearTimeout(failTimeout);
    showError('Error cargando el script JSONP de Google. Revisá que la hoja esté "Publicada en la web" y accesible.');
    loader.style.display = 'none';
  };
  document.head.appendChild(s);

  function renderGrid(vendidosSet) {
    grid.innerHTML = '';
    for (let i=1; i<=200; i++) {
      const d = document.createElement('div');
      d.className = 'cell' + (vendidosSet.has(i) ? ' sold' : '');
      d.textContent = i;
      grid.appendChild(d);
    }
  }

  function showError(msg) {
    errBox.style.display = 'block';
    errBox.textContent = msg;
    console.error(msg);
    status.textContent = 'Error — ver detalle arriba.';
  }

})();
</script>
</body>
</html>
